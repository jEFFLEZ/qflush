<!doctype html>
<html>
  <head><meta charset="utf-8"></head>
  <body>
    <h3>NPZ Scores</h3>

    <div>
      <label for="daemonUrl">Daemon URL:</label>
      <input id="daemonUrl" type="text" style="width:60%" />
    </div>
    <div>
      <label for="adminToken">Admin Token:</label>
      <input id="adminToken" type="password" style="width:60%" />
      <button id="save">Save</button>
    </div>

    <pre id="content">Loading...</pre>
    <button id="refresh">Refresh</button>
    <button id="reset">Reset Scores</button>
    <script>
      const vscode = acquireVsCodeApi();
      let DAEMON_URL = 'http://localhost:4500';
      let ADMIN_TOKEN = '';

      function setInputs() {
        const d = document.getElementById('daemonUrl');
        const t = document.getElementById('adminToken');
        if (d) d.value = DAEMON_URL;
        if (t) t.value = ADMIN_TOKEN || '';
      }

      async function load(){
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/npz/scores?token=${encodeURIComponent(ADMIN_TOKEN)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('fetch failed ' + res.status);
          const data = await res.json();
          document.getElementById('content').innerText = JSON.stringify(data, null, 2);
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      }

      document.getElementById('refresh').addEventListener('click', load);
      document.getElementById('reset').addEventListener('click', async ()=>{
        try {
          const url = `${DAEMON_URL.replace(/\/$/, '')}/npz/scores/reset?token=${encodeURIComponent(ADMIN_TOKEN)}`;
          await fetch(url, { method: 'POST' });
          load();
        } catch (e) {
          document.getElementById('content').innerText = 'Error: ' + String(e);
        }
      });

      document.getElementById('save').addEventListener('click', () => {
        const d = (document.getElementById('daemonUrl') as HTMLInputElement).value;
        const t = (document.getElementById('adminToken') as HTMLInputElement).value;
        DAEMON_URL = d || DAEMON_URL;
        ADMIN_TOKEN = t || ADMIN_TOKEN;
        // send save message to extension to persist in settings
        vscode.postMessage({ type: 'saveConfig', daemonUrl: DAEMON_URL, token: ADMIN_TOKEN });
        load();
      });

      // Listen for messages from the extension to receive config securely
      window.addEventListener('message', event => {
        const msg = event.data;
        if (msg && msg.type === 'config') {
          if (msg.daemonUrl) DAEMON_URL = msg.daemonUrl;
          if (msg.token) ADMIN_TOKEN = msg.token;
          setInputs();
          load();
        } else if (msg && msg.type === 'saved') {
          // ack from extension
          const info = msg.info || 'saved';
          document.getElementById('content').innerText = String(info);
        }
      });

      // initial load in case no config arrives
      setTimeout(() => { setInputs(); load(); }, 200);
    </script>
  </body>
</html>