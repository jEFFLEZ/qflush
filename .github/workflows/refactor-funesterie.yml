name: Refactor Funesterie Engine

on:
  workflow_dispatch: {}

# avoid running multiple concurrent refactor jobs and cancel in-progress when a new one is triggered
concurrency:
  group: refactor-funesterie-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  refactor:
    # use a dedicated self-hosted runner labeled 'funesterie' to avoid contention
    runs-on: [self-hosted, funesterie, Windows]

    env:
      QFLUSHD_PORT: '43421'
      QFLUSH_SPYDER_ADMIN_PORT: '4022'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Build TypeScript
        run: npx tsc -p .

      - name: Install qflush globally on runner (from repo tgz or npm)
        shell: pwsh
        run: |
          Write-Host 'Installing qflush CLI for this runner (prefer published runner variant)'
          $npmBin = $null
          try {
            # try installing published runner variant from npm first
            try {
              Write-Host 'Attempting to install published runner package @funeste38/qflush-runner@3.1.5-runner'
              npm install -g @funeste38/qflush-runner@3.1.5-runner --no-audit --no-fund
              Write-Host 'Installed @funeste38/qflush-runner from npm'
              $npmBin = (npm config get prefix 2>$null).Trim()
              if (-not $npmBin -or $npmBin -eq '') { $npmBin = Join-Path $env:APPDATA 'npm' }
              "$([String]::Format('PATH={0};{1}', $npmBin, $env:PATH))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host 'Runner variant installed and PATH updated for job'
            } catch {
              Write-Host 'Failed to install published runner package, falling back to local pack/install'
              # create tgz from repo
              npm pack
              $tgz = Get-ChildItem -Path . -Filter '*.tgz' -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
              if ($tgz) {
                Write-Host "Found tgz: $($tgz.FullName) - installing globally"
                # if runner-package exists, pack and install it instead
                if (Test-Path 'runner-package/package.json') {
                  Write-Host 'Packaging runner-specific variant (local)'
                  Push-Location runner-package
                  npm pack
                  $runnerTgz = Get-ChildItem -Path .. -Filter '*.tgz' -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
                  Pop-Location
                  if ($runnerTgz) {
                    Write-Host "Installing runner variant: $($runnerTgz.FullName)"
                    npm install -g $runnerTgz.FullName
                    # also install main tgz for library usage
                    npm install -g $tgz.FullName
                    $npmBin = (npm config get prefix 2>$null).Trim() || Join-Path $env:APPDATA 'npm'
                    "$([String]::Format('PATH={0};{1}', $npmBin, $env:PATH))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                    Write-Host 'Runner variant and main package installed and PATH updated for job'
                    exit 0
                  }
                }
                npm install -g $tgz.FullName
                $npmBin = (npm config get prefix 2>$null).Trim() || Join-Path $env:APPDATA 'npm'
                "$([String]::Format('PATH={0};{1}', $npmBin, $env:PATH))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                Write-Host 'qflush installed and PATH updated for job'
              } else {
                Write-Host 'No tgz produced by npm pack, skipping install'
              }
            }
          } finally {
            # no-op
          }

      - name: Ensure Funesterie rules file
        shell: pwsh
        run: |
          if (-not (Test-Path '.qflush')) { New-Item -ItemType Directory -Path .qflush | Out-Null }
          $rules = @{ 
            version = '1.0';
            architecture = @{
              core = 'src/core';
              cortex = 'src/cortex';
              utils = 'src/utils';
              commands = 'src/commands';
              legacy = 'src/legacy'
            };
            rules = @{
              commands_no_logic = $true;
              router_pure = $true;
              apply_pure = $true;
              no_direct_fs_in_cortex = $true;
              logs_uniform = $true;
              config_centralized = $true;
              state_in_core = $true
            };
            refactor = @{
              move_legacy = $true;
              rebuild_imports = $true;
              fix_paths = $true;
              split_large_files = $true;
              auto_generate_types = $true
            }
          }
          $rules | ConvertTo-Json -Depth 5 | Set-Content -Path .qflush/funesterie.rules.json -Encoding UTF8

      - name: Run refactor engine (TS)
        run: npx ts-node --prefer-ts-exts scripts/refactor-funesterie.ts .qflush/funesterie.rules.json

      - name: Run tests
        run: npm test

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/refactor-funesterie
          commit-message: "refactor: applied Funesterie Rules via A11 Engine"
          title: "Auto-refactor (Funesterie Engine)"

      - name: Optional: Install Spyder (from npm)
        if: env.INSTALL_SPYDER == 'true'
        shell: pwsh
        env:
          TAR: 'C:/Windows/System32/tar.exe'
        run: |
          Write-Host 'Installing @funeste38/spyder (optional)'
          try { npm cache clean --force; Write-Host 'npm cache cleaned' } catch { Write-Host 'npm cache clean failed, continuing' }
          $pkg = '@funeste38/spyder'
          $max = 3
          $installed = $false
          for ($i = 1; $i -le $max; $i++) {
            Write-Host "Attempt $i to install $pkg"
            try {
              npm i $pkg --no-audit --no-fund
              Write-Host "$pkg installed successfully"
              $installed = $true
              break
            } catch {
              Write-Host "Install attempt $i failed: $_"
              Start-Sleep -Seconds (2 * $i)
            }
          }
          if (-not $installed) {
            Write-Host 'Primary npm install failed â€” attempting GitHub fallback'
            try {
              npm i git+https://github.com/jEFFLEZ/spyder.git --no-audit --no-fund
              Write-Host 'Installed spyder from GitHub'
              $installed = $true
            } catch {
              Write-Host 'GitHub fallback failed: ' $_
            }
          }
          if (-not $installed) { Write-Host 'Spyder not installed; tests may skip spyder-related behavior' }
