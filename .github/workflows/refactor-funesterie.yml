name: Refactor Funesterie Engine

on:
  workflow_dispatch: {}

# avoid running multiple concurrent refactor jobs and cancel in-progress when a new one is triggered
concurrency:
  group: refactor-funesterie-${{ github.ref }}
  cancel-in-progress: true

jobs:
  refactor:
    # use a dedicated self-hosted runner labeled 'funesterie' to avoid contention
    runs-on: [self-hosted, funesterie, Windows]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node setup
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Build TypeScript
        run: npx tsc -p .

      - name: Install qflush globally on runner (from repo tgz)
        shell: pwsh
        run: |
          Write-Host 'Packing qflush and installing globally for this runner session'
          # create tgz from repo
          npm pack
          $tgz = Get-ChildItem -Path . -Filter '*.tgz' -File | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($tgz) {
            Write-Host "Found tgz: $($tgz.FullName) - installing globally"
            npm install -g $tgz.FullName
            # robustly determine npm global bin for Windows runners (avoid `npm bin -g` which may not exist)
            try {
              $npmPrefix = (npm config get prefix 2>$null).Trim()
              if ($npmPrefix -and $npmPrefix -ne '') {
                # try common locations relative to prefix
                $candidate1 = Join-Path $npmPrefix 'node_modules' 'npm' 'bin'
                $candidate2 = Join-Path $npmPrefix 'bin'
                if (Test-Path $candidate1) { $npmBin = $candidate1 } 
                elseif (Test-Path $candidate2) { $npmBin = $candidate2 } 
                else { $npmBin = $npmPrefix }
              } else {
                $npmBin = $null
              }
            } catch {
              $npmBin = $null
            }
            if (-not $npmBin -or $npmBin -eq '') {
              # fallback to APPDATA npm folder which is common on Windows
              $npmBin = Join-Path $env:APPDATA 'npm'
            }
            Write-Host "Global npm bin: $npmBin"
            # ensure the path string is exported for subsequent steps
            "$([String]::Format('PATH={0};{1}', $npmBin, $env:PATH))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host 'qflush installed and PATH updated for job'
          } else {
            Write-Host 'No tgz produced by npm pack, skipping install'
          }

      - name: Install Spyder (from npm, optional)
        shell: pwsh
        continue-on-error: true
        env:
          QFLUSH_SKIP_GLOBAL_INSTALLS: '1'
          QFLUSH_EMBED_SERVICES: '0'
          SPYDER_SKIP_START: '1'
          TAR: 'C:/Windows/System32/tar.exe'
        run: |
          Write-Host 'Preparing to install @funeste38/spyder (optional)'
          # try to clean npm cache to avoid corrupted tarballs
          try { npm cache clean --force; Write-Host 'npm cache cleaned' } catch { Write-Host 'npm cache clean failed, continuing' }

          $pkg = '@funeste38/spyder'
          $max = 3
          $installed = $false
          for ($i = 1; $i -le $max; $i++) {
            Write-Host "Attempt $i to install $pkg"
            try {
              npm i $pkg --no-audit --no-fund
              Write-Host "$pkg installed successfully"
              $installed = $true
              break
            } catch {
              Write-Host "Install attempt $i failed: $_"
              Start-Sleep -Seconds (2 * $i)
            }
          }

          if (-not $installed) {
            Write-Host 'Primary npm install failed â€” attempting GitHub fallback'
            try {
              npm i git+https://github.com/jEFFLEZ/spyder.git --no-audit --no-fund
              Write-Host 'Installed spyder from GitHub'
              $installed = $true
            } catch {
              Write-Host 'GitHub fallback failed: ' $_
            }
          }

          if ($installed) {
            if (Test-Path 'spyder') {
              Write-Host 'Attempting to build local spyder package (if present)'
              npm --prefix spyder run build --if-present || Write-Host 'spyder build failed or not present, continuing'
            } else {
              Write-Host 'No local spyder folder present, skipping local build'
            }
          } else {
            Write-Host 'Spyder not installed; continuing without spyder (step marked optional)'
          }

      - name: Ensure Funesterie rules file
        shell: pwsh
        run: |
          if (-not (Test-Path '.qflush')) { New-Item -ItemType Directory -Path .qflush | Out-Null }
          $rules = @{ 
            version = '1.0';
            architecture = @{
              core = 'src/core';
              cortex = 'src/cortex';
              utils = 'src/utils';
              commands = 'src/commands';
              legacy = 'src/legacy'
            };
            rules = @{
              commands_no_logic = $true;
              router_pure = $true;
              apply_pure = $true;
              no_direct_fs_in_cortex = $true;
              logs_uniform = $true;
              config_centralized = $true;
              state_in_core = $true
            };
            refactor = @{
              move_legacy = $true;
              rebuild_imports = $true;
              fix_paths = $true;
              split_large_files = $true;
              auto_generate_types = $true
            }
          }
          $rules | ConvertTo-Json -Depth 5 | Set-Content -Path .qflush/funesterie.rules.json -Encoding UTF8

      - name: Run refactor engine (TS)
        run: npx ts-node --prefer-ts-exts scripts/refactor-funesterie.ts .qflush/funesterie.rules.json

      - name: Run tests
        run: npm test

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/refactor-funesterie
          commit-message: "refactor: applied Funesterie Rules via A11 Engine"
          title: "Auto-refactor (Funesterie Engine)"
